import 'package:flutter/material.dart';import 'package:flutter/services.dart';import 'dart:math' as math;import 'package:cloud_firestore/cloud_firestore.dart';class CreateProgramPage extends StatefulWidget {  const CreateProgramPage({super.key});  @override  State<CreateProgramPage> createState() => _CreateProgramPageState();}class _CreateProgramPageState extends State<CreateProgramPage>    with TickerProviderStateMixin {  final _formKey = GlobalKey<FormState>();  final TextEditingController titleController = TextEditingController();  final TextEditingController descriptionController = TextEditingController();  final TextEditingController instructorController = TextEditingController();  final TextEditingController chaptersController = TextEditingController();  late final AnimationController _shakeController;  late final Animation<double> _shakeAnimation;  late final AnimationController _submitController;  bool _isSubmitting = false;  static const Color deepPurple = Color(0xFF6A1B9A);  static const Color accentPurple = Color(0xFF9C27B0);  static const LinearGradient headerGradient = LinearGradient(    colors: [Color(0xFFEDE7F6), Color(0xFFF8BBD0)],    begin: Alignment.topCenter,    end: Alignment.bottomCenter,  );  @override  void initState() {    super.initState();    _shakeController =        AnimationController(vsync: this, duration: const Duration(milliseconds: 400));    _shakeAnimation = TweenSequence<double>([      TweenSequenceItem(tween: Tween(begin: 0.0, end: -10.0), weight: 1),      TweenSequenceItem(tween: Tween(begin: -10.0, end: 8.0), weight: 1),      TweenSequenceItem(tween: Tween(begin: 8.0, end: -6.0), weight: 1),      TweenSequenceItem(tween: Tween(begin: -6.0, end: 4.0), weight: 1),      TweenSequenceItem(tween: Tween(begin: 4.0, end: 0.0), weight: 1),    ]).animate(_shakeController);    _submitController =        AnimationController(vsync: this, duration: const Duration(milliseconds: 900));  }  @override  void dispose() {    titleController.dispose();    descriptionController.dispose();    instructorController.dispose();    chaptersController.dispose();    _shakeController.dispose();    _submitController.dispose();    super.dispose();  }  Future<void> _playShake() async {    await _shakeController.forward(from: 0.0);  }  /// Converts the program title into a valid Firestore document ID:  /// lowercase, spaces replaced by underscores, and non-alphanumeric removed.  String _createDocumentId(String title) {    // 1. Convert to lowercase    String id = title.toLowerCase();    // 2. Replace spaces with underscores    id = id.replaceAll(' ', '_');    // 3. Remove any characters that are not alphanumeric or underscore    id = id.replaceAll(RegExp(r'[^a-z0-9_]'), '');    return id;  }  /// ✅ This function now saves the new course to Firestore using the custom ID  Future<void> _validateAndSubmit() async {    FocusScope.of(context).unfocus();    final valid = _formKey.currentState?.validate() ?? false;    if (!valid) {      HapticFeedback.lightImpact();      _playShake();      return;    }    setState(() => _isSubmitting = true);    // Generate the document ID    final String programTitle = titleController.text.trim();    final String documentId = _createDocumentId(programTitle);    // Define the Firestore reference using the custom document ID    final DocumentReference courseRef = FirebaseFirestore.instance        .collection('artifacts')        .doc('eduxcel')        .collection('courses')        .doc(documentId); // Use .doc() with the custom ID    try {      // 1. Check if a document with this ID already exists      final DocumentSnapshot existingDoc = await courseRef.get();      if (existingDoc.exists) {        if (!mounted) return;        setState(() => _isSubmitting = false);        // Show an error message because the program title is a duplicate        ScaffoldMessenger.of(context).showSnackBar(          const SnackBar(            content: Text('❌ Program title already exists! Choose a different name.'),            backgroundColor: Colors.red,          ),        );        _playShake();        return;      }      // 2. If it doesn't exist, use .set() to create the document      await courseRef.set({        'title': programTitle,        'description': descriptionController.text.trim(),        'instructor': instructorController.text.trim(),        'chapters': int.parse(chaptersController.text.trim()),        'created_at': FieldValue.serverTimestamp(),        'users': 0, // you can track enrollments later      });      await _submitController.animateTo(1.0,          duration: const Duration(milliseconds: 500), curve: Curves.easeOutBack);      if (!mounted) return;      setState(() => _isSubmitting = false);      await _showSuccessDialog();      // Clear form fields after successful save      titleController.clear();      descriptionController.clear();      instructorController.clear();      chaptersController.clear();      // Signal to the previous screen (ProgramsPage) that a refresh is needed      if(mounted) {        Navigator.of(context).pop(true);      }    } catch (e) {      if (!mounted) return;      setState(() => _isSubmitting = false);      ScaffoldMessenger.of(context).showSnackBar(        SnackBar(content: Text('❌ Failed to create program: $e')),      );    }  }  Future<void> _showSuccessDialog() async {    await showGeneralDialog(      context: context,      barrierDismissible: true,      barrierLabel: 'Success',      transitionDuration: const Duration(milliseconds: 400),      pageBuilder: (context, anim1, anim2) => const SizedBox.shrink(),      transitionBuilder: (context, animation, _, __) {        final curved = CurvedAnimation(parent: animation, curve: Curves.elasticOut);        return ScaleTransition(          scale: curved,          child: Center(            child: Material(              color: Colors.white,              borderRadius: BorderRadius.circular(16),              elevation: 12,              child: Padding(                padding: const EdgeInsets.all(24.0),                child: SizedBox(                  width: math.min(MediaQuery.of(context).size.width * 0.9, 400),                  child: Column(                    mainAxisSize: MainAxisSize.min,                    children: [                      const Icon(Icons.check_circle_outline,                          color: deepPurple, size: 64),                      const SizedBox(height: 16),                      const Text(                        'Program Created Successfully!',                        style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),                      ),                      const SizedBox(height: 12),                      const Text(                        'Your new program has been added to the database.',                        textAlign: TextAlign.center,                      ),                      const SizedBox(height: 20),                      ElevatedButton(                        // FIX: Changed pop behavior to return 'true' to ProgramsPage                        onPressed: () => Navigator.of(context).pop(true),                        style: ElevatedButton.styleFrom(                          backgroundColor: deepPurple,                          shape: RoundedRectangleBorder(                            borderRadius: BorderRadius.circular(10),                          ),                        ),                        child: const Padding(                          padding:                          EdgeInsets.symmetric(vertical: 10, horizontal: 20),                          child: Text('Close',                              style: TextStyle(color: Colors.white)),                        ),                      ),                    ],                  ),                ),              ),            ),          ),        );      },    );    _submitController.reset();  }  InputDecoration _inputDecoration(String label, IconData icon) {    return InputDecoration(      labelText: label,      prefixIcon: Icon(icon, color: deepPurple),      filled: true,      fillColor: Colors.grey.shade50,      border: OutlineInputBorder(        borderRadius: BorderRadius.circular(10),        borderSide: BorderSide.none,      ),      focusedBorder: OutlineInputBorder(        borderRadius: BorderRadius.circular(10),        borderSide: const BorderSide(color: accentPurple, width: 2.0),      ),    );  }  @override  Widget build(BuildContext context) {    return Scaffold(      extendBodyBehindAppBar: true,      extendBody: true,      appBar: AppBar(        title: const Text("Create New Program"),        backgroundColor: Colors.transparent,        elevation: 0,        systemOverlayStyle: SystemUiOverlayStyle.light,      ),      body: Container(        width: double.infinity,        height: double.infinity,        decoration: const BoxDecoration(gradient: headerGradient),        child: SafeArea(          bottom: false,          child: SingleChildScrollView(            padding: const EdgeInsets.all(16),            child: AnimatedBuilder(              animation: _shakeAnimation,              builder: (context, child) {                return Transform.translate(                  offset: Offset(_shakeAnimation.value, 0),                  child: child,                );              },              child: Container(                decoration: BoxDecoration(                  color: Colors.white,                  borderRadius: BorderRadius.circular(16),                  boxShadow: [                    BoxShadow(                      color: Colors.black.withOpacity(0.15),                      blurRadius: 16,                      offset: const Offset(0, 8),                    ),                  ],                ),                padding: const EdgeInsets.all(20),                child: Form(                  key: _formKey,                  child: Column(                    children: [                      TextFormField(                        controller: titleController,                        decoration:                        _inputDecoration("Program Title", Icons.school_outlined),                        validator: (v) =>                        v == null || v.isEmpty ? 'Enter program title' : null,                      ),                      const SizedBox(height: 18),                      TextFormField(                        controller: descriptionController,                        maxLines: 4,                        decoration: _inputDecoration(                            "Description", Icons.text_snippet_outlined),                        validator: (v) =>                        v == null || v.isEmpty ? 'Enter description' : null,                      ),                      const SizedBox(height: 18),                      TextFormField(                        controller: instructorController,                        decoration:                        _inputDecoration("Instructor", Icons.person_outline),                        validator: (v) =>                        v == null || v.isEmpty ? 'Enter instructor name' : null,                      ),                      const SizedBox(height: 18),                      TextFormField(                        controller: chaptersController,                        keyboardType: TextInputType.number,                        decoration: _inputDecoration(                            "Number of Chapters", Icons.numbers_outlined),                        validator: (v) {                          if (v == null || v.isEmpty) return 'Enter number of chapters';                          final num? val = num.tryParse(v);                          if (val == null || val <= 0) return 'Enter a valid number';                          return null;                        },                      ),                      const SizedBox(height: 28),                      AnimatedBuilder(                        animation: _submitController,                        builder: (context, _) {                          final v = _submitController.value;                          final showProgress = v > 0.1 && v < 0.9;                          final showCheck = v >= 0.9;                          return ElevatedButton(                            onPressed: _isSubmitting ? null : _validateAndSubmit,                            style: ElevatedButton.styleFrom(                              backgroundColor: deepPurple,                              padding: const EdgeInsets.symmetric(                                  horizontal: 46, vertical: 16),                              shape: RoundedRectangleBorder(                                  borderRadius: BorderRadius.circular(10)),                            ),                            child: SizedBox(                              height: 20,                              child: Stack(                                alignment: Alignment.center,                                children: [                                  Opacity(                                    opacity: showProgress || showCheck ? 0.0 : 1.0,                                    child: const Text(                                      "Create Program",                                      style: TextStyle(                                          fontWeight: FontWeight.bold,                                          color: Colors.white),                                    ),                                  ),                                  if (showProgress)                                    const SizedBox(                                      width: 22,                                      height: 22,                                      child: CircularProgressIndicator(                                        strokeWidth: 2.5,                                        valueColor:                                        AlwaysStoppedAnimation(Colors.white),                                      ),                                    ),                                  if (showCheck)                                    const Icon(Icons.check,                                        color: Colors.white, size: 26),                                ],                              ),                            ),                          );                        },                      ),                    ],                  ),                ),              ),            ),          ),        ),      ),    );  }}